<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>律師訴狀生成系統</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        // 全局錯誤處理函數
        window.onerror = function(message, source, lineno, colno, error) {
            console.error("全局錯誤:", message, "來源:", source, "行:", lineno);
            alert("系統發生錯誤: " + message);
            return true;
        };
        
        // 調試工具
        window.debugInfo = {
            logRequests: true,
            logResponses: true,
            version: "wtlee328-debug-2025-04-10",
            user: "wtlee328",
            timestamp: "2025-04-10 17:24:38"
        };
    </script>
    <!-- CSS 樣式保持不變 -->
    <style>
        :root {
            --primary-color: #1a3b68;
            --secondary-color: #f8f9fa;
            --accent-color: #d4a760;
            --text-color: #333;
            --border-color: #ddd;
            --success-color: #28a745;
            --error-color: #dc3545;
            --warning-color: #ffc107;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Noto Sans TC', Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: #f5f5f5;
            padding: 0;
            margin: 0;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: center;
            margin-bottom: 2rem;
        }
        
        header h1 {
            margin: 0;
            font-size: 1.8rem;
        }
        
        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
            margin-top: 0.5rem;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        h2 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary-color);
        }
        
        .required:after {
            content: " *";
            color: var(--error-color);
        }
        
        input[type="text"],
        input[type="email"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(212, 167, 96, 0.2);
        }
        
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .form-section {
            background-color: var(--secondary-color);
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--primary-color);
        }
        
        .form-section h3 {
            margin-bottom: 1rem;
            color: var(--primary-color);
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-col {
            flex: 1;
            min-width: 200px;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        button:hover {
            background-color: #0f2a53;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        button i {
            margin-right: 8px;
        }
        
        .buttons-container {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .secondary-btn {
            background-color: #6c757d;
        }
        
        .secondary-btn:hover {
            background-color: #5a6268;
        }
        
        .helper-text {
            display: block;
            margin-top: 5px;
            font-size: 0.85rem;
            color: #666;
        }
        
        .error-message {
            color: var(--error-color);
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }
        
        input.error,
        textarea.error,
        select.error {
            border-color: var(--error-color);
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            color: white;
            display: none;
        }
        
        .spinner {
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 5px solid var(--accent-color);
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 4px;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            z-index: 1001;
            transition: transform 0.3s ease;
            transform: translateX(150%);
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification i {
            margin-right: 10px;
            font-size: 1.2rem;
        }
        
        .notification.success {
            background-color: var(--success-color);
        }
        
        .notification.error {
            background-color: var(--error-color);
        }
        
        .notification.warning {
            background-color: var(--warning-color);
            color: #212529;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
            margin-left: 8px;
            color: var(--primary-color);
            cursor: help;
        }
        
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 250px;
            background-color: #333;
            color: white;
            text-align: left;
            border-radius: 4px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-weight: normal;
            font-size: 0.85rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        footer {
            text-align: center;
            padding: 1rem;
            margin-top: 2rem;
            color: #666;
            font-size: 0.9rem;
        }
        
        /* 模態窗口樣式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            width: 80%;
            max-width: 1000px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
        }
        
        .document-area {
            background-color: white;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Microsoft JhengHei', 'Noto Sans TC', sans-serif;
            white-space: pre-wrap;
            line-height: 1.8;
        }
        
        .document-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        /* 列印樣式 */
        @media print {
            .modal-header, .document-buttons, .close {
                display: none !important;
            }
            
            .modal, .modal-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                margin: 0;
                padding: 0;
                overflow: visible;
                background-color: white;
                box-shadow: none;
            }
            
            .document-area {
                border: none;
                padding: 0;
            }
        }
        
        /* Debug 面板 */
        .debug-panel {
            position: fixed;
            bottom: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.8);
            color: #0f0;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-width: 300px;
            max-height: 200px;
            overflow: auto;
            z-index: 9999;
            display: none;
        }
        
        .debug-panel.active {
            display: block;
        }
        
        /* 響應式樣式 */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .card {
                padding: 1rem;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .form-col {
                width: 100%;
            }
            
            button {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .buttons-container {
                flex-direction: column;
            }
            
            .modal-content {
                width: 95%;
                margin: 5% auto;
            }
        }

        /* 新增的按鈕樣式 */
        .btn-uniform {
            width: 120px !important;
            height: 44px !important;
            padding: 10px !important;
            margin: 5px !important;
            font-size: 0.95rem !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }
    </style>
</head>
<body>
    <header>
        <h1>律師訴狀生成系統</h1>
    </header>

    <div class="container">
        <div class="card">
            <h2>案件資料填寫</h2>
            <form id="legalDocForm">
                <!-- 表單部分保持不變 -->
                <div class="form-section">
                    <h3>基本資料</h3>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="caseType" class="required">訴狀類型</label>
                                <select id="caseType" name="caseType" required>
                                    <option value="">請選擇訴狀類型</option>
                                    <option value="民事起訴狀">民事起訴狀</option>
                                    <option value="民事答辯狀">民事答辯狀</option>
                                    <option value="民事準備狀">民事準備狀</option>
                                    <option value="民事辯論意旨狀">民事辯論意旨狀</option>
                                    <option value="民事上訴狀">民事上訴狀</option>
                                </select>
                                <div class="error-message" id="caseType-error">請選擇訴狀類型</div>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="caseNumber">案號 (選填)</label>
                                <input type="text" id="caseNumber" name="caseNumber" placeholder="例：112年度訴字第1234號">
                                <span class="helper-text">若為新案件可不填</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="courtName">法院名稱</label>
                                <select id="courtName" name="courtName">
                                    <option value="臺灣臺北地方法院">臺灣臺北地方法院</option>
                                    <option value="臺灣新北地方法院">臺灣新北地方法院</option>
                                    <option value="臺灣桃園地方法院">臺灣桃園地方法院</option>
                                    <option value="臺灣臺中地方法院">臺灣臺中地方法院</option>
                                    <option value="臺灣臺南地方法院">臺灣臺南地方法院</option>
                                    <option value="臺灣高雄地方法院">臺灣高雄地方法院</option>
                                    <option value="其他法院">其他法院</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="branchName">股別 (選填)</label>
                                <input type="text" id="branchName" name="branchName" placeholder="例：甲股">
                                <span class="helper-text">若不確定可不填</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>當事人資料</h3>
                    <div class="form-group">
                        <label for="plaintiff" class="required">原告資料
                            <span class="tooltip"><i class="fas fa-question-circle"></i>
                                <span class="tooltip-text">請填寫完整資料，包含姓名、地址、法定代理人（如有）等。公司請填寫統一編號。</span>
                            </span>
                        </label>
                        <textarea id="plaintiff" name="plaintiff" placeholder="例：張三 住台北市中正區忠孝東路100號" required></textarea>
                        <div class="error-message" id="plaintiff-error">請填寫原告資料</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="plaintiffRepresentative">原告訴訟代理人 (選填)</label>
                        <textarea id="plaintiffRepresentative" name="plaintiffRepresentative" placeholder="例：王律師 設台北市信義區松仁路50號10樓"></textarea>
                        <span class="helper-text">若無委任律師可不填</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="defendant" class="required">被告資料</label>
                        <textarea id="defendant" name="defendant" placeholder="例：李四 住高雄市前鎮區中山二路300號" required></textarea>
                        <div class="error-message" id="defendant-error">請填寫被告資料</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="defendantRepresentative">被告訴訟代理人 (選填)</label>
                        <textarea id="defendantRepresentative" name="defendantRepresentative" placeholder="例：陳律師 設台北市中山區南京東路150號5樓"></textarea>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>案件內容</h3>
                    <div class="form-group">
                        <label for="caseTitle" class="required">案件標題</label>
                        <input type="text" id="caseTitle" name="caseTitle" placeholder="例：請求給付貨款事件" required>
                        <div class="error-message" id="caseTitle-error">請填寫案件標題</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="facts" class="required">案件事實
                            <span class="tooltip"><i class="fas fa-question-circle"></i>
                                <span class="tooltip-text">請按時間順序條列案件主要事實，每個事件一行，至少包含5個關鍵事件。</span>
                            </span>
                        </label>
                        <textarea id="facts" name="facts" rows="6" placeholder="例：
1. 原告於112年1月1日與被告簽訂買賣契約
2. 原告於112年1月15日交付貨物
3. 被告於112年2月1日應付款但未支付
..." required></textarea>
                        <div class="error-message" id="facts-error">請填寫案件事實，至少5條</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="requests" class="required">請求事項
                            <span class="tooltip"><i class="fas fa-question-circle"></i>
                                <span class="tooltip-text">請條列您希望法院判決的具體請求內容，每項請求一行。</span>
                            </span>
                        </label>
                        <textarea id="requests" name="requests" rows="4" placeholder="例：
1. 被告應給付原告新台幣30萬元及自起訴狀送達翌日起至清償日止，按年息5%計算之利息
2. 訴訟費用由被告負擔
..." required></textarea>
                        <div class="error-message" id="requests-error">請填寫請求事項</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="evidence" class="required">證據資料
                            <span class="tooltip"><i class="fas fa-question-circle"></i>
                                <span class="tooltip-text">請條列您提供的證據，例如：原證1、原證2等，每項證據一行。</span>
                            </span>
                        </label>
                        <textarea id="evidence" name="evidence" rows="4" placeholder="例：
原證1：買賣契約書影本1份
原證2：送貨單影本1份
原證3：催款通知書影本1份
..." required></textarea>
                        <div class="error-message" id="evidence-error">請填寫證據資料</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="laws">適用法條 (選填)
                            <span class="tooltip"><i class="fas fa-question-circle"></i>
                                <span class="tooltip-text">請列出適用的法條，每條一行。</span>
                            </span>
                        </label>
                        <textarea id="laws" name="laws" rows="3" placeholder="例：
民法第153條（契約之成立）
民法第199條（給付遲延）
..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="precedents">相關判例 (選填)
                            <span class="tooltip"><i class="fas fa-question-circle"></i>
                                <span class="tooltip-text">請列出相關判例，每則一行。</span>
                            </span>
                        </label>
                        <textarea id="precedents" name="precedents" rows="2" placeholder="例：
最高法院109年台上字第123號判決
..."></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <h3>聯絡資訊</h3>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="email" class="required">電子郵件</label>
                                <input type="email" id="email" name="email" placeholder="user@example.com" required>
                                <div class="error-message" id="email-error">請填寫有效的電子郵件</div>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="phone">聯絡電話 (選填)</label>
                                <input type="text" id="phone" name="phone" placeholder="例：0912345678">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="buttons-container" id="buttonsContainer">
                    <!-- 按鈕將由JavaScript動態添加 -->
                </div>
            </form>
        </div>
    </div>

    <!-- 模態窗口用於顯示生成的訴狀 -->
    <div id="documentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>生成的訴狀</h2>
                <span class="close">&times;</span>
            </div>
            <div class="document-area" id="documentContent"></div>
            <div class="document-buttons">
                <button id="copyBtn" class="secondary-btn">
                    <i class="fas fa-copy"></i> 複製內容
                </button>
                <button id="printBtn">
                    <i class="fas fa-print"></i> 列印訴狀
                </button>
                <button id="downloadBtn">
                    <i class="fas fa-download"></i> 下載文件
                </button>
                <button id="emailBtn">
                    <i class="fas fa-envelope"></i> 寄送至信箱
                </button>
            </div>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <p>正在生成訴狀，請稍候...</p>
        <p id="estimatedTime">預計需時：30-60秒</p>
    </div>

    <div class="notification" id="notification"></div>
    <div class="debug-panel" id="debugPanel"></div>

    <footer>
        <p>© 2025 律師訴狀生成系統 | 本系統模擬律師風格，僅供參考</p>
        <p><small>使用本系統生成的訴狀建議由專業律師審核後使用</small></p>
        <p><small>wtlee328 (2025-04-10 17:24:38)</small></p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('legalDocForm');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const notification = document.getElementById('notification');
            const debugPanel = document.getElementById('debugPanel');
            const modal = document.getElementById('documentModal');
            const closeModalBtn = document.querySelector('.close');
            const documentContent = document.getElementById('documentContent');
            const copyBtn = document.getElementById('copyBtn');
            const printBtn = document.getElementById('printBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const emailBtn = document.getElementById('emailBtn');
            const buttonsContainer = document.getElementById('buttonsContainer');
            
            // N8N Webhook URL - 使用 Ngrok URL
            const webhookUrl = 'https://73f5-122-100-75-75.ngrok-free.app/webhook/legal-document';
            
            // 調試功能
            function log(message, type = 'info') {
                if (window.debugInfo.logRequests || type !== 'request') {
                    console.log(`[${type.toUpperCase()}][${new Date().toLocaleTimeString()}] ${message}`);
                    
                    // 添加到調試面板
                    const logEntry = document.createElement('div');
                    logEntry.className = `log-entry ${type}`;
                    logEntry.textContent = `[${type}] ${message}`;
                    debugPanel.appendChild(logEntry);
                    
                    // 限制調試面板日誌數量
                    while (debugPanel.childNodes.length > 50) {
                        debugPanel.removeChild(debugPanel.firstChild);
                    }
                    
                    // 滾動到最新日誌
                    debugPanel.scrollTop = debugPanel.scrollHeight;
                }
            }
            
            // 顯示/隱藏調試面板 (按Alt+D快速鍵)
            document.addEventListener('keydown', function(e) {
                if (e.altKey && e.key === 'd') {
                    debugPanel.classList.toggle('active');
                    e.preventDefault();
                }
            });
            
            // 保存生成的訴狀到本地存儲
            function saveDocumentToLocalStorage(document) {
                localStorage.setItem('wtlee328_lastDocument', document);
                localStorage.setItem('wtlee328_lastDocumentTime', new Date().toISOString());
                log('訴狀已保存到本地存儲');
            }
            
            // 從本地存儲恢復訴狀
            function loadDocumentFromLocalStorage() {
                return {
                    document: localStorage.getItem('wtlee328_lastDocument'),
                    timestamp: localStorage.getItem('wtlee328_lastDocumentTime')
                };
            }
            
            // 關閉模態窗口
            closeModalBtn.addEventListener('click', function() {
                modal.style.display = 'none';
            });
            
            // 點擊模態窗口外部時關閉
            window.addEventListener('click', function(event) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
            
            // 複製訴狀內容
            copyBtn.addEventListener('click', function() {
                const textToCopy = documentContent.textContent;
                navigator.clipboard.writeText(textToCopy).then(function() {
                    showNotification('訴狀內容已複製到剪貼簿', 'success');
                }, function() {
                    showNotification('無法複製內容，請手動選取並複製', 'error');
                });
            });
            
            // 列印訴狀
            printBtn.addEventListener('click', function() {
                window.print();
            });
            
            // 下載訴狀為文本文件
            downloadBtn.addEventListener('click', function() {
                const text = documentContent.textContent;
                const caseType = document.getElementById('caseType').value || '訴狀';
                const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD格式
                const filename = `${caseType}_${today}_wtlee328.txt`;
                
                const blob = new Blob([text], {type: 'text/plain;charset=utf-8'});
                
                // 創建下載鏈接
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification(`已下載文件：${filename}`, 'success');
                log(`訴狀已下載為 ${filename}`);
            });
            
            // 發送訴狀到用戶信箱
            emailBtn.addEventListener('click', function() {
                const userEmail = document.getElementById('email').value;
                if (!userEmail) {
                    showNotification('請先在表單中填寫有效的電子郵件地址', 'error');
                    return;
                }
                
                showNotification(`訴狀將發送至：${userEmail}，請稍候...`, 'success');
                
                // 在實際應用中，這裡會發送請求到後端進行郵件發送
                setTimeout(() => {
                    showNotification(`訴狀已成功發送至您的信箱：${userEmail}`, 'success');
                    log(`訴狀已發送至郵箱 ${userEmail}`);
                }, 2000);
            });
                        
            // 顯示通知
            function showNotification(message, type) {
                notification.textContent = message;
                notification.className = `notification ${type}`;
                
                if (type === 'success') {
                    notification.innerHTML = '<i class="fas fa-check-circle"></i> ' + message;
                } else if (type === 'error') {
                    notification.innerHTML = '<i class="fas fa-exclamation-circle"></i> ' + message;
                } else if (type === 'warning') {
                    notification.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ' + message;
                }
                
                notification.classList.add('show');
                
                setTimeout(function() {
                    notification.classList.remove('show');
                }, 5000);
            }
            
            // 清除錯誤訊息
            function clearErrors() {
                document.querySelectorAll('.error-message').forEach(function(el) {
                    el.style.display = 'none';
                });
                
                document.querySelectorAll('.error').forEach(function(el) {
                    el.classList.remove('error');
                });
            }
            
            // 顯示錯誤訊息
            function showError(fieldId, message) {
                const field = document.getElementById(fieldId);
                const errorElement = document.getElementById(`${fieldId}-error`);
                
                if (field && errorElement) {
                    field.classList.add('error');
                    errorElement.textContent = message;
                    errorElement.style.display = 'block';
                }
            }
            
            // 表單驗證
            function validateForm() {
                let isValid = true;
                clearErrors();
                
                // 必填欄位檢查
                const requiredFields = [
                    { id: 'caseType', message: '請選擇訴狀類型' },
                    { id: 'plaintiff', message: '請填寫原告資料' },
                    { id: 'defendant', message: '請填寫被告資料' },
                    { id: 'caseTitle', message: '請填寫案件標題' },
                    { id: 'facts', message: '請填寫案件事實' },
                    { id: 'requests', message: '請填寫請求事項' },
                    { id: 'evidence', message: '請填寫證據資料' },
                    { id: 'email', message: '請填寫電子郵件' }
                ];
                
                requiredFields.forEach(function(field) {
                    const element = document.getElementById(field.id);
                    if (!element.value.trim()) {
                        showError(field.id, field.message);
                        isValid = false;
                    }
                });
                
                // 案件事實至少3條
                const facts = document.getElementById('facts').value.trim();
                if (facts && facts.split('\n').filter(line => line.trim()).length < 3) {
                    showError('facts', '請至少填寫3條案件事實');
                    isValid = false;
                }
                
                // 電子郵件格式驗證
                const email = document.getElementById('email').value.trim();
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (email && !emailRegex.test(email)) {
                    showError('email', '請填寫有效的電子郵件格式');
                    isValid = false;
                }
                
                return isValid;
            }

            // 新增: 提取 action_input 內容
            function extractActionInput(responseData) {
                try {
                    // 如果是字符串，嘗試解析為 JSON
                    if (typeof responseData === 'string') {
                        try {
                            const parsedData = JSON.parse(responseData);
                            if (parsedData.action === "Final Answer" && parsedData.action_input) {
                                log("從 JSON 中提取 action_input", 'process');
                                return parsedData.action_input;
                            }
                            
                            // 檢查是否有 output 字段，且是否包含 Final Answer
                            if (parsedData.output) {
                                try {
                                    const nestedOutput = JSON.parse(parsedData.output);
                                    if (nestedOutput.action === "Final Answer" && nestedOutput.action_input) {
                                        log("從嵌套 JSON.output 中提取 action_input", 'process');
                                        return nestedOutput.action_input;
                                    }
                                } catch (e) {
                                    // 如果 output 不是 JSON，直接返回 output
                                    return parsedData.output;
                                }
                            }
                            
                            // 沒有找到 action_input，返回原始數據
                            return responseData;
                            
                        } catch (e) {
                            // 不是 JSON，直接返回原始文本
                            return responseData;
                        }
                    } 
                    
                    // 如果是對象，直接檢查
                    if (responseData && typeof responseData === 'object') {
                        // 檢查是否有 action 和 action_input
                        if (responseData.action === "Final Answer" && responseData.action_input) {
                            log("從對象中提取 action_input", 'process');
                            return responseData.action_input;
                        }
                        
                        // 檢查是否有 output 字段
                        if (responseData.output) {
                            // 檢查 output 是否為字符串且包含 action_input
                            if (typeof responseData.output === 'string') {
                                try {
                                    const nestedOutput = JSON.parse(responseData.output);
                                    if (nestedOutput.action === "Final Answer" && nestedOutput.action_input) {
                                        log("從對象的 output 中提取 action_input", 'process');
                                        return nestedOutput.action_input;
                                    }
                                } catch (e) {
                                    // output 不是 JSON，直接返回 output
                                    return responseData.output;
                                }
                            } else if (typeof responseData.output === 'object') {
                                // output 是對象，檢查是否有 action_input
                                if (responseData.output.action === "Final Answer" && responseData.output.action_input) {
                                    log("從對象的 output 對象中提取 action_input", 'process');
                                    return responseData.output.action_input;
                                }
                            }
                            
                            // 沒有找到 action_input，但有 output
                            return responseData.output;
                        }
                    }
                    
                    // 所有檢查都失敗，返回原始數據
                    return responseData;
                } catch (e) {
                    console.error("提取 action_input 時出錯:", e);
                    return responseData; // 出錯時返回原始數據
                }
            }

            // 處理訴狀文本中的轉義字符
            function processLegalDocumentText(text) {
                if (!text) return '';
                
                // 首先嘗試提取 action_input
                const extractedText = extractActionInput(text);
                log("提取後的文本類型: " + typeof extractedText, 'debug');
                
                // 處理可能的 JSON 解析和轉義字符
                let processedText = extractedText;
                
                // 如果是字符串，處理轉義字符
                if (typeof processedText === 'string') {
                    // 將 \n 轉換為實際換行符
                    processedText = processedText
                        .replace(/\\n/g, '\n')
                        .replace(/\\"/g, '"')
                        .replace(/\\t/g, '\t')
                        .replace(/\\\\/g, '\\');
                } else if (processedText && typeof processedText === 'object') {
                    // 如果是對象，轉換為字符串
                    processedText = JSON.stringify(processedText, null, 2);
                }
                
                return processedText;
            }
            
            // 創建按鈕函數 - 統一按鈕大小和樣式
            function createButton(id, text, icon, color, clickHandler, isSubmit = false) {
                const button = document.createElement('button');
                button.id = id;
                button.type = isSubmit ? 'submit' : 'button';
                button.className = 'btn-uniform';
                button.style.backgroundColor = color;
                button.innerHTML = `<i class="fas fa-${icon}"></i> ${text}`;
                if (clickHandler) {
                    button.addEventListener('click', clickHandler);
                }
                return button;
            }
            
            // 重構按鈕容器
            function setupButtons() {
                // 清空按鈕容器
                buttonsContainer.innerHTML = '';
                
                // 創建左側按鈕群組
                const leftButtonGroup = document.createElement('div');
                leftButtonGroup.style.display = 'flex';
                leftButtonGroup.style.gap = '10px';
                leftButtonGroup.style.flexWrap = 'wrap';
                
                // 創建示範按鈕
                const demoButton = createButton('demoBtn', '示範', 'magic', '#6c757d', function() {
                    document.getElementById('caseType').value = '民事起訴狀';
                    document.getElementById('plaintiff').value = '林大明 住臺北市信義區忠孝東路五段7號';
                    document.getElementById('plaintiffRepresentative').value = '';
                    document.getElementById('defendant').value = '王小華 住臺中市西屯區文心路二段128號';
                    document.getElementById('defendantRepresentative').value = '';
                    document.getElementById('caseTitle').value = '請求給付貨款事件';
                    document.getElementById('facts').value = '1. 原告於民國112年1月1日與被告簽訂汽車買賣契約\n2. 原告依約於112年1月15日交付汽車乙輛\n3. 被告依約應於112年2月1日支付價金新台幣50萬元\n4. 被告屆期未支付價金\n5. 原告於112年2月15日發函催告，被告仍未支付';
                    document.getElementById('requests').value = '1. 被告應給付原告新台幣50萬元及自起訴狀送達之翌日起至清償日止，按年息5%計算之利息\n2. 訴訟費用由被告負擔';
                    document.getElementById('evidence').value = '原證1: 買賣契約書影本1份\n原證2: 交付證明影本1份\n原證3: 催告函影本1份';
                    document.getElementById('laws').value = '民法第153條（契約之成立）\n民法第199條（給付遲延）';
                    document.getElementById('precedents').value = '最高法院98年度台上字第1689號判決';
                    document.getElementById('email').value = 'wtlee328@gmail.com';
                    document.getElementById('phone').value = '0912345678';
                    clearErrors();
                    log('已填入示範數據', 'ui');
                    showNotification('已填入示範數據', 'success');
                });
                
                // 創建測試按鈕
                const testButton = createButton('testBtn', '測試', 'vial', '#28a745', function() {
                    document.getElementById('caseType').value = '民事起訴狀';
                    document.getElementById('plaintiff').value = '林大明 住臺北市信義區忠孝東路五段7號';
                    document.getElementById('defendant').value = '王小華 住臺中市西屯區文心路二段128號';
                    document.getElementById('caseTitle').value = '請求給付貨款事件';
                    document.getElementById('facts').value = '1. 原告於民國112年1月1日與被告簽訂汽車買賣契約\n2. 原告依約於112年1月15日交付汽車乙輛\n3. 被告依約應於112年2月1日支付價金新台幣50萬元\n4. 被告屆期未支付價金\n5. 原告於112年2月15日發函催告，被告仍未支付';
                    document.getElementById('requests').value = '1. 被告應給付原告新台幣50萬元及自起訴狀送達之翌日起至清償日止，按年息5%計算之利息\n2. 訴訟費用由被告負擔';
                    document.getElementById('evidence').value = '原證1: 買賣契約書影本1份\n原證2: 交付證明影本1份\n原證3: 催告函影本1份';
                    document.getElementById('laws').value = '民法第153條（契約之成立）\n民法第199條（給付遲延）';
                    document.getElementById('precedents').value = '最高法院98年度台上字第1689號判決';
                    document.getElementById('email').value = 'wtlee328@gmail.com';
                    document.getElementById('phone').value = '0912345678';
                    clearErrors();
                    
                    log('已填入示範數據，準備測試流程', 'test');
                    showNotification('已填入示範數據，準備提交表單', 'success');
                    
                    // 模擬測試
                    setTimeout(() => {
                        loadingOverlay.style.display = 'flex';
                        
                        // 模擬處理時間
                        setTimeout(() => {
                            loadingOverlay.style.display = 'none';
                            
                            // 測試數據 - 包含 action_input
                            const testResponse = {
                                "action": "Final Answer",
                                "action_input": "民事起訴狀\n案　　號：114 年度 訴 字第 ____ 號\n股　　別：　____ 股\n\n原　　告　林大明\n　　　　　　住臺北市信義區忠孝東路五段7號\n\n被　　告　王小華\n　　　　　　住臺中市西屯區文心路二段128號\n\n為請求給付貨款事件，依法起訴事：\n\n　　　　　　聲　明\n一、被告應給付原告新臺幣伍拾萬元整，及自本起訴狀繕本送達翌日起至清償日止，按年息百分之五計算之利息。\n二、訴訟費用由被告負擔。\n三、如受不利判決，願供擔保請准宣告假執行。\n\n　　　　　　事實及理由\n一、緣原告與被告於民國112年1月1日簽訂汽車買賣契約（原證1），約定被告應於112年2月1日支付買賣價金新臺幣伍拾萬元整。原告業已依約於112年1月15日交付系爭車輛，並經被告簽收無誤（原證2）。\n\n二、詎被告屆期未依約履行給付價金義務，經原告於112年2月15日以存證信函催告履行（原證3），被告仍置之不理，迄今分文未付。依民法第367條規定，買受人對於出賣人有支付約定價金之義務，被告顯已違反契約義務。\n\n三、復按民法第229條第1項規定，給付有確定期限者，債務人自期限屆滿時起負遲延責任。本件被告遲延給付已逾一年餘，依同法第233條第1項規定，原告自得請求依法定利率計算之遲延利息。\n\n四、為此懇請 鈞院鑒核，賜判如訴之聲明，以維權益。\n\n　　　　　　證　據\n原證1：買賣契約書影本乙份\n原證2：車輛交付證明書影本乙份\n原證3：郵局存證信函暨回執影本乙份\n\n　　　　　　附　件\n一、本狀副本乙份\n二、證物清單乙紙\n\n謹　狀\n臺灣臺北地方法院民事庭　公鑒\n\n中華民國114年4月10日\n\n　　　　　　　　　　　　具狀人　原　告　林大明（簽名蓋章）"
                            };
                            
                            // 提取 action_input 並處理
                            const finalOutput = extractActionInput(testResponse);
                            
                            // 保存到本地存儲
                            saveDocumentToLocalStorage(finalOutput);
                            
                            // 顯示訴狀內容
                            documentContent.textContent = finalOutput;
                            modal.style.display = 'block';
                            showNotification('測試訴狀已生成！', 'success');
                        }, 2000);
                    }, 500);
                });
                
                // 創建重置按鈕
                const resetButton = createButton('resetBtn', '重置', 'undo', '#6c757d', function() {
                    if (confirm('確定要重置表單嗎？所有填寫的內容將被清除。')) {
                        form.reset();
                        clearErrors();
                        log('表單已重置');
                        showNotification('表單已重置', 'info');
                    }
                });
                
                // 檢查是否有上次生成的訴狀，添加恢復按鈕
                const savedData = loadDocumentFromLocalStorage();
                if (savedData.document) {
                    const timestamp = new Date(savedData.timestamp);
                    const now = new Date();
                    const diff = Math.floor((now - timestamp) / (1000 * 60)); // 分鐘差
                    
                    if (diff < 60) { // 如果不到60分鐘
                        showNotification(`發現 ${diff} 分鐘前生成的訴狀`, 'info');
                        log(`檢測到本地存儲的訴狀，生成於 ${diff} 分鐘前`, 'info');
                        
                        // 創建恢復按鈕
                        const restoreButton = createButton('restoreBtn', '恢復', 'history', '#17a2b8', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            const processedText = processLegalDocumentText(savedData.document);
                            documentContent.textContent = processedText;
                            modal.style.display = 'block';
                            log('已從本地存儲恢復訴狀', 'info');
                            showNotification('已成功恢復先前的訴狀', 'success');
                            loadingOverlay.style.display = 'none';
                            
                            return false;
                        });
                        
                        // 添加恢復按鈕
                        leftButtonGroup.appendChild(restoreButton);
                    }
                }
                
                // 添加按鈕到左側群組
                leftButtonGroup.appendChild(demoButton);
                leftButtonGroup.appendChild(testButton);
                leftButtonGroup.appendChild(resetButton);
                
                // 創建生成按鈕
                const submitButton = createButton('submitBtn', '生成', 'file-alt', '#1a3b68', null, true);
                
                // 添加按鈕到容器
                buttonsContainer.appendChild(leftButtonGroup);
                buttonsContainer.appendChild(submitButton);
                
                // 添加表單提交事件
                form.addEventListener('submit', handleFormSubmit);
            }
            
            // 表單提交處理函數
            function handleFormSubmit(e) {
                e.preventDefault();
                
                if (!validateForm()) {
                    showNotification('請檢查表單並修正錯誤', 'error');
                    return;
                }
                
                // 收集表單數據
                const formData = {
                    caseType: document.getElementById('caseType').value,
                    caseNumber: document.getElementById('caseNumber').value,
                    courtInfo: {
                      name: document.getElementById('courtName').value,
                      branch: document.getElementById('branchName').value
                    },
                    parties: {
                      plaintiff: {
                        info: document.getElementById('plaintiff').value,
                        representative: document.getElementById('plaintiffRepresentative').value || "無"
                      },
                      defendant: {
                        info: document.getElementById('defendant').value,
                        representative: document.getElementById('defendantRepresentative').value || "無"
                      }
                    },
                    case: {
                      title: document.getElementById('caseTitle').value,
                      facts: document.getElementById('facts').value.split('\n').filter(line => line.trim()),
                      requests: document.getElementById('requests').value.split('\n').filter(line => line.trim()),
                      evidence: document.getElementById('evidence').value.split('\n').filter(line => line.trim()),
                      laws: document.getElementById('laws').value ? document.getElementById('laws').value.split('\n').filter(line => line.trim()) : [],
                      precedents: document.getElementById('precedents').value ? document.getElementById('precedents').value.split('\n').filter(line => line.trim()) : []
                    },
                    contact: {
                      email: document.getElementById('email').value,
                      phone: document.getElementById('phone').value
                    },
                    metadata: {
                      timestamp: "2025-04-10T17:24:38.000Z",
                      system: "wtlee328-legal-doc-system",
                      version: "1.0",
                      created: "2025-04-10 17:24:38",
                      user: "wtlee328"
                    }
                };
                
                // 顯示加載中覆蓋層
                loadingOverlay.style.display = 'flex';
                log('正在發送表單數據到 n8n...', 'request');
                
                // 調整剩餘時間顯示 
                let secondsLeft = 45;
                const timerInterval = setInterval(() => {
                    secondsLeft--;
                    document.getElementById('estimatedTime').textContent = `預計剩餘時間：${secondsLeft} 秒`;
                    if (secondsLeft <= 0) {
                        clearInterval(timerInterval);
                    }
                }, 1000);
                
                // 發送數據到 n8n webhook 並獲取真實數據
                fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-Id': 'wtlee328',
                        'X-Request-Time': '2025-04-10 17:24:38'
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => {
                    clearInterval(timerInterval);
                    log(`收到 n8n 回應，狀態碼: ${response.status}`, 'response');
                    
                    if (!response.ok) {
                        throw new Error(`伺服器回應錯誤: ${response.status} ${response.statusText}`);
                    }
                    
                    return response.text().then(text => {
                        // 記錄原始文本
                        log("收到原始回應文本", 'debug');
                        console.log("原始文本:", text);
                        
                        // 嘗試解析為 JSON
                        try {
                            return JSON.parse(text);
                        } catch (e) {
                            log("回應不是有效的 JSON，直接使用文本", 'debug');
                            // 如果不能解析為 JSON，直接返回原始文本
                            return text;
                        }
                    });
                })
                .then(data => {
                    loadingOverlay.style.display = 'none';
                    
                    // 調試日誌 - 顯示所有接收到的數據
                    log("從n8n收到真實回應數據", 'response');
                    console.log(data);
                    
                    // 處理訴狀文本 - 提取 action_input 並處理轉義字符
                    const finalOutput = processLegalDocumentText(data);
                    log("處理完成，準備顯示", 'process');
                    
                    // 保存到本地存儲
                    saveDocumentToLocalStorage(finalOutput);
                    
                    // 顯示訴狀內容
                    documentContent.textContent = finalOutput;
                    modal.style.display = 'block';
                    showNotification('訴狀已成功生成！', 'success');
                })
                .catch(error => {
                    loadingOverlay.style.display = 'none';
                    clearInterval(timerInterval);
                    console.error('Error:', error);
                    log(`請求錯誤: ${error.message}`, 'error');
                    showNotification('發生錯誤：' + error.message, 'error');
                });
            }
            
            // 初始化按鈕
            setupButtons();
            
            // 初始日誌
            log("系統已初始化，用戶：wtlee328，時間：2025-04-10 17:24:38", 'init');
            log("等待用戶操作...", 'init');
            
            // 添加快速鍵提示
            showNotification('按下 Alt+D 可以顯示/隱藏調試面板', 'info');
        });
    </script>
</body>
</html>